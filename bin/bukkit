#!/usr/bin/env ruby

$: << File.expand_path(File.dirname(__FILE__) + "/../lib")

require 'rubygems'
require 'commander/import'

require 'bukkit.rb'

program :version, Bukkit::VERSION
program :description, "A Command Line Interface for CraftBukkit."

command :new do |c|
	c.syntax = "bukkit new my-awesome-server-name [options]"
	c.summary = "Create a new Bukkit server."
	c.description = "Create a new Bukkit server with the given name."
	c.example "Creates a new server with the name 'my-awesome-server-name'.", "bukkit new my-awesome-server-name"
	c.option "--rb", "Create a new server with the recommended build."
	c.option "--beta", "Create a new server with the beta build."
	c.option "--dev", "Create a new server with the dev build."
  c.option "-f", "--force", "Overwrites the chosen directory if it already exists."
	# TODO: Those are bools, pass the t/f values to a case statement then pass that to Bukkit::new
	c.action do |args, options|
    # Make 'dir' = to first arg
    dir = args.shift

		if options.rb == true
			build = "rb"
		elsif options.beta == true
			build = "beta"
		elsif options.dev == true
			build = "dev"
		else
			build = ask "What build would you like? (rb/beta/dev) "
			case build.downcase
			when "rb", "recommended", "r"
				build = "rb"
			when "beta", "b"
				build = "beta"
			when "dev", "d", "developer"
				build = "dev"
			else
				abort "ERROR: Invalid option '#{build}'\nTry `bukkit new --help`"
			end
		end

    if options.force == true
      force = true
    else
      force = nil
    end

    begin
		  Bukkit::new(build, dir, force)
    rescue TypeError
      abort "ERROR: Server name not specified.\nTry `bukkit new my-awesome-server-name`"
    end
	end
end

command :start do |c|
  c.syntax = "bukkit start"
  c.summary = "Start your server."
  c.description = "Start the bukkit server. (Must be in server's root)"
  c.example "Start your server.", "bukkit start"
  c.action do |args, options|
    puts "Starting the server...".green
    Bukkit::start
  end
end

command :install do |c|
  c.syntax = "bukkit install my-favorite-plugin [options]"
  c.summary = "Install a new bukkit plugin."
  c.description = "Installs a new bukkit plugin. Must be on dev.bukkit.org. (can also be a zip!)"

  c.example "Installs the plugin 'my-favorite-plugin' (will ask for website when done).", "bukkit install my-favorite-plugin"

  c.example "Installs the plugin 'my-favorite-plugin' and doesn't ask to open it's website", "bukkit install my-favorite-plugin --nowebsite"
  c.option "--nowebsite", "Doesn't ask for website after install."
  
  c.action do |args, options|
    if args.empty?
      abort "ERROR: ".red + "You didn't enter an argument."
    else
      if options.nowebsite == true
        Bukkit::Install.normal(args.shift.downcase, true)
      else
        Bukkit::Install.normal(args.shift.downcase)
      end
    end
  end
end

command :website do |c|
  c.syntax = "bukkit website my-favorite-plugin"
  c.summary = "Open a plugin's website."
  c.description = "Opens a plugin's website your default browser."
  c.example "Open a plugin's website.", "bukkit website my-favorite-plugin"
  c.option "-u", "--url", "Only show the url."
  c.action do |args, options|
    if args.empty?
      abort "ERROR: ".red + "You didn't enter an argument."
    else
      plugin = args.shift.downcase
      if options.url == true
        Bukkit.url(plugin)
      else
        Bukkit.website(plugin)
      end
    end
  end
end

command :update do |c|
  c.syntax = "bukkit update [options]"
  c.summary = "Get the latest version of bukkit."
  c.description = "Download the latest version of CraftBukkit."
  c.example "Updates your server to the latest recommended build.", "bukkit update --rb"
  c.option "--rb", "Get the latest recommended build."
  c.option "--beta", "Get the latest beta build."
  c.option "--dev", "Get the latest dev build."
  # TODO: Those are bools, pass the t/f values to a case statement then pass that to Bukkit::new
  c.action do |args, options|
    if options.rb == true
      build = "rb"
    elsif options.beta == true
      build = "beta"
    elsif options.dev == true
      build = "dev"
    else
      build = ask "What build would you like? (rb/beta/dev) "
      case build.downcase
      when "rb", "recommended", "r"
        build = "rb"
      when "beta", "b"
        build = "beta"
      when "dev", "d", "developer"
        build = "dev"
      else
        abort "ERROR:".red + " Invalid option '#{build}'\nTry `bukkit new --help`"
      end
    end
    # Send args & opts to Bukkit::update
    begin
      Bukkit::update(build)
    rescue
      abort "ERROR:".red + " Something bad happened!.\nTry `bukkit new --help`\n  If error persists create an issue with specific details here:\n        https://github.com/JesseHerrick/bukkit/issues/new"
    end
  end
end